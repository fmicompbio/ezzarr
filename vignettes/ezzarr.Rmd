---
title: "Using ez-zarr in R"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{Using ez-zarr in R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Load the `ezzarr` package

```{r setup}
library(ezzarr)
```

# Check the version of ez-zarr

This will create the conda environment if it doesn't already exist.

```{r}
getEzZarrVersion()
```

# Get the path to the environment

```{r}
getEzZarrEnvPath()
```

# Download example data to temporary directory

```{r}
td <- tempdir()
url <- "https://zenodo.org/records/10519143/files/20200812-CardiomyocyteDifferentiation14-Cycle1_mip.zarr.zip"
download.file(url, destfile = file.path(td, basename(url)))
unzip(file.path(td, basename(url)), 
      exdir = td)
zarrpath <- file.path(td, sub("\\.zip$", "", basename(url)))
fs::dir_tree(zarrpath, recurse = 3)
```

# Activate the environment and load an example image

```{r}
env <- enableEzZarr()
print(env$plt$get_backend())
env$plt$switch_backend("agg")
print(env$plt$get_backend())
img <- env$ez_zarr$ome_zarr$Image(path = file.path(zarrpath, "B/03/0"))
img
img$tree(level = 1)
```

# Get details about the image

```{r}
## Channel information
length(img$nchannels_image)
img$channels[[1]]

## Label names
img$label_names

## Scales for a given pyramid level
unlist(img$get_scale(pyramid_level = "2"))

## Path
img$get_path()

## Image name
img$name

## Table names
img$table_names
```

# Plot image

Plots in `ez-zarr` are implemented using `matplotlib.pyplot` and display
correctly when using the plot methods interactively from python
(e.g. `img.plot()`) or from R via `reticulate` (e.g. `img$plot()`).
A special case is the use of plot methods in non-interactive Rmarkdown or
Quarto documents. In these, the plots are only shown for `python` code chunks,
which is used in the examples below (note the `r.img` syntax to refer to the
`img` object in the R process).

## With default settings

```{python}
r.img.plot()
```

The corresponding R code (for interactive use) would look like:

```{r, eval = FALSE}
img$plot()
```

## Adding a scale bar, limiting the channel range

```{python}
r.img.plot(channels = [0],
           channel_colors = ["white"],
           channel_ranges = [[100, 600]],
           scalebar_micrometer = 150,
           scalebar_color = "yellow",
           scalebar_position = "topleft",
           scalebar_label = True,
           fig_width_inch = 5,
           fig_height_inch = 4,
           fig_dpi = 100,
           axis_style = "micrometer")
```

The corresponding R code for interactive is shown below. Please note that
you need to use specific R data structures to satisfy the expected arguments
types of the python function. For example, a python list (`[...]`) has to be
created using an R list (`list(...)`) and not a vector. For a list of
the conversions that reticulate uses between R and python data structures see
[reticulate type conversions](https://rstudio.github.io/reticulate/articles/calling_python.html#type-conversions).

```{r, eval=FALSE}
img$plot(channels = list(0L),
         channel_colors = list("white"),
         channel_ranges = list(c(100, 600)),
         scalebar_micrometer = 150L,
         scalebar_color = "yellow",
         scalebar_position = "topleft",
         scalebar_label = TRUE,
         fig_width_inch = 5,
         fig_height_inch = 4,
         fig_dpi = 100,
         axis_style = "micrometer")
```

## Zoom in

```{python}
r.img.plot(pyramid_level = "0",
           upper_left_yx = [130, 140],
           lower_right_yx = [300, 310],
           scalebar_micrometer = 30,
           scalebar_color = "magenta",
           fig_width_inch = 5,
           fig_height_inch = 5,
           fig_dpi = 100)
```

## Overlay nuclei segmentation

```{python}
r.img.plot(label_name = "nuclei", 
           pyramid_level = "0",
           upper_left_yx = [130, 140],
           lower_right_yx = [300, 310],
           scalebar_micrometer = 30,
           scalebar_color = "magenta",
           fig_width_inch = 5,
           fig_height_inch = 5,
           fig_dpi = 100)
```

# Import and plot entire plate

```{r}
plt <- env$ez_zarr$ome_zarr$import_plate(zarrpath)
```

Again, we use a python code chunk for the plot to be included in our
compiled notebook (not needed for interactive use):

```{python}
r.plt.plot()
```


# Session info

```{r}
sessionInfo()
```

